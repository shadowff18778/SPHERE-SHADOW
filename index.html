<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPHERE SHADOW - Accès Sécurisé</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration de la police Inter (standard et lisible) et du thème rouge/sombre -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Style global du corps en noir intense */
        body {
            background-color: #0d0d0d; /* Presque noir */
        }
        /* Animation de chargement spéciale (Sphère qui tourne) */
        @keyframes sphere-spin {
            0% { transform: rotate(0deg) scale(0.8); opacity: 1; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 0.9; }
            100% { transform: rotate(360deg) scale(0.8); opacity: 1; }
        }
        .sphere-loader {
            width: 80px;
            height: 80px;
            border: 8px solid #330000; /* Bordure rouge très sombre */
            border-top-color: #e53e3e; /* Rouge vif pour l'animation */
            border-radius: 50%;
            animation: sphere-spin 1.5s linear infinite;
            filter: drop-shadow(0 0 10px rgba(229, 62, 62, 0.7)); /* Ombre rougeoyer */
        }
        /* Animation pour le spinner du bouton */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .button-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* CSS pour le compteur d'alerte rouge clignotant */
        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        .lockout-warning {
            color: #f56565 !important; /* Rouge d'alerte vif */
            animation: blink-red 0.8s ease-in-out infinite;
            font-weight: bold;
        }
        
        /* === Style du panneau VPN (Effet flou Apple/Fluent) === */
        .vpn-panel-blur {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* Compatibilité Safari */
            background-color: rgba(30, 41, 59, 0.7); /* bg-slate-800/70 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-center items-center text-gray-100 p-4 transition-all duration-500">

    <!-- 1. MODALE DE CONSENTEMENT COOKIE -->
    <div id="cookie-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-700 opacity-0 pointer-events-none">
        <div class="bg-gray-800 border-2 border-red-700 rounded-xl shadow-2xl p-6 md:p-8 mx-4 w-full max-w-md transform transition-all duration-500 scale-95">
            <h2 class="text-xl sm:text-2xl font-bold text-red-400 mb-4 border-b border-red-800 pb-2">ACCÈS PROTOCOLE SHADOW</h2>
            <p class="text-gray-300 mb-6 text-sm sm:text-base">
                Pour maintenir la sécurité et l'expérience optimisée du réseau SPHERE SHADOW, nous utilisons des "cookies de session". Acceptez-vous le protocole ?
            </p>
            <div class="flex justify-end space-x-4">
                <button onclick="handleCookieAcceptance(false)" class="px-5 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition duration-300 shadow-md text-sm sm:text-base">
                    Refuser
                </button>
                <button onclick="handleCookieAcceptance(true)" id="accept-cookie-button" 
                        class="px-5 py-2 bg-red-800 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 shadow-lg shadow-red-900/50 relative overflow-hidden flex items-center justify-center min-w-[12rem] text-sm sm:text-base">
                    <span id="cookie-button-text">Accepter et Continuer</span>
                    <span id="cookie-loader" class="absolute inset-0 bg-red-800 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 text-sm font-normal">
                        <svg class="button-spinner h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 4.305c.291 1.255.438 2.544.438 3.824 0 4.418-3.582 8-8 8s-8-3.582-8-8c0-1.28.147-2.569.438-3.824m-4.882-1.571a.75.75 0 010-1.492.75.75 0 010 1.492zM20 12h2a10 10 0 00-20 0h2zm-8-8v2"></path>
                        </svg>
                        Analyse...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. ÉCRAN DE CHARGEMENT STYLÉ (Global) -->
    <div id="loading-screen" class="fixed inset-0 bg-[#0d0d0d] flex flex-col items-center justify-center z-40 transition-opacity duration-500 opacity-0 pointer-events-none">
        <div class="sphere-loader"></div>
        <p id="loading-text" class="mt-8 text-lg sm:text-xl font-mono text-red-500 tracking-wider text-center px-4">
            INITIATION DU PROTOCOLE (0%)...
        </p>
        <div class="w-full max-w-xs sm:max-w-md h-2 mt-4 bg-gray-800 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-red-600 transform origin-left transition-transform duration-100" style="width: 0%;"></div>
        </div>
    </div>

    <!-- 3. PORTAIL D'ACCÈS SÉCURISÉ (Contenu principal) -->
    <div id="access-gate" class="flex flex-col items-center justify-center w-full max-w-xl p-8 bg-gray-900 border-2 border-red-900 rounded-xl shadow-2xl shadow-red-900/60 transition-opacity duration-500 opacity-0 pointer-events-none">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-red-600 mb-6 tracking-wide">
            SPHERE SHADOW
        </h1>
        <p class="text-red-400 text-base sm:text-lg mb-4 text-center border-b border-red-800 pb-4 w-full">
            AUTHENTIFICATION REQUISE : CLÉ D'ACCÈS
        </p>
        
        <p id="lockout-status" class="mt-2 mb-6 text-center text-red-500 font-mono text-base sm:text-lg min-h-[1.5rem]"></p>
        
        <form id="access-form" class="w-full">
            <input type="password" id="secret-code" placeholder="Entrez la clé secrète..." required
                   class="w-full p-4 mb-4 text-center bg-gray-800 border-2 border-red-700 rounded-lg text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-300 text-xl tracking-widest shadow-inner shadow-black/50">

            <button type="submit"
                    class="w-full py-3 bg-red-700 text-white text-lg font-bold rounded-lg hover:bg-red-600 active:bg-red-800 transition transform duration-300 hover:scale-[1.02] shadow-xl shadow-red-900/70">
                ACTIVER LE PROTOCOLE
            </button>
        </form>

        <p id="message-box" class="mt-6 text-sm text-center text-red-400 min-h-[1.5rem] opacity-0 transition-opacity duration-300"></p>
    </div>

    <!-- 4. PAGE DE CONTENU (Après succès) - MAINTENANT PLEIN ÉCRAN AVEC TÉLÉCHARGEMENT -->
    <div id="success-content" class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="h-full w-full flex flex-col bg-gray-900 border-2 border-red-700 shadow-2xl shadow-red-900/50">
            <!-- Bandeau de titre Dark Rouge/VERT adapté -->
            <header id="success-header" class="p-3 bg-red-900/40 border-b-2 border-red-700 transition-colors duration-500">
                <h2 class="text-lg sm:text-xl md:text-2xl font-extrabold text-red-400 tracking-wider text-center transition-colors duration-500" id="header-text">
                    SPHERE SHADOW — FICHIERS SÉCURISÉS (MEDIAFIRE)
                </h2>
            </header>

            <!-- Contenu de Téléchargement -->
            <main class="flex-grow flex flex-col items-center justify-center p-8 text-center">
                <!-- Titre de téléchargement adapté -->
                <p class="text-xl sm:text-2xl md:text-3xl font-bold text-red-400 mb-6 px-2 transition-colors duration-500" id="download-title">
                    FICHIER SHADOW PRÊT AU TÉLÉCHARGEMENT
                </p>
                <p class="text-base sm:text-lg text-gray-300 mb-10 p-2 bg-gray-800 rounded-lg shadow-inner">
                    Nom du Fichier: SHADOW - John Wick 2014.mp4
                </p>

                <!-- Bouton de Téléchargement Stylé (Taille augmentée et icône améliorée) -->
                <button id="download-button" onclick="startDownloadLoading()"
                        class="download-button-visual w-32 h-32 sm:w-36 sm:h-36 md:w-44 md:h-44 flex items-center justify-center bg-red-700 rounded-full shadow-2xl shadow-red-900/80 hover:bg-red-600 transition duration-500 transform hover:scale-105 active:scale-95 group relative overflow-hidden focus:outline-none">
                    
                    <!-- Icône de Téléchargement (maintenant plus grande et plus épaisse) -->
                    <svg class="w-16 h-16 sm:w-20 sm:h-20 text-white transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                </button>

                <p id="download-message" class="mt-6 text-sm text-center text-red-400 opacity-0 transition-opacity duration-300"></p>
            </main>

            <!-- Footer discret Rouge/VERT -->
            <footer id="success-footer" class="p-1 bg-red-900/40 border-t-2 border-red-700 text-center text-xs text-red-500 transition-colors duration-500">
                Protocole activé. Données transmises via canal sécurisé.
            </footer>
            
            <!-- NOUVEAU: Bouton de connexion VPN flottant -->
            <button onclick="toggleVPNPanel()" id="vpn-toggle-button" 
                    class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 p-3 bg-gray-700 text-white rounded-full shadow-lg hover:bg-gray-600 transition duration-300 z-30 focus:outline-none">
                <!-- Icône Wi-Fi/Connexion -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.649A9.95 9.95 0 0112 4c4.418 0 8 3.582 8 8z"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- 5. NOUVEAU: Panneau de Connexion VPN (Apple/Fluent Design) -->
    <!-- CORRECTION: Ajout de 'invisible' et 'opacity-0' initiales pour garantir qu'aucun pixel n'est visible au chargement -->
    <div id="vpn-panel" class="fixed bottom-0 right-0 m-4 sm:m-6 w-full max-w-xs transform translate-y-full transition-all duration-500 z-40 invisible opacity-0 pointer-events-none">
        <!-- Conteneur avec effet de flou -->
        <div class="vpn-panel-blur border border-white/20 rounded-xl shadow-2xl p-4">
            
            <!-- Header du Panneau -->
            <div class="flex justify-between items-center mb-4 border-b border-white/30 pb-2">
                <h3 class="text-lg font-semibold text-white">Connexions Réseau</h3>
                <button onclick="toggleVPNPanel()" class="text-white/70 hover:text-white transition">
                    <!-- Icône X -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Liste des Réseaux -->
            <div id="network-list" class="mb-4">
                <h4 class="text-sm font-medium text-white/80 mb-2">Réseaux Disponibles:</h4>
                
                <!-- Le seul réseau SHADOW VPN -->
                <div id="shadow-vpn-network" class="flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-white/10 transition duration-200" onclick="showVPNPasswordForm()">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span class="text-white font-medium">SHADOW VPN</span>
                    </div>
                    <span class="text-xs text-green-400">Excellente Fréquence</span>
                </div>
                
                <!-- Bouton de Déconnexion (Visible si connecté) -->
                <button id="vpn-disconnect-button" onclick="disconnectVPN()"
                        class="w-full mt-2 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-500 transition duration-300 opacity-0 pointer-events-none">
                    Déconnecter du VPN
                </button>
            </div>
            
            <!-- Formulaire de Mot de Passe VPN -->
            <form id="vpn-password-form" class="hidden">
                <h4 class="text-sm font-medium text-white/80 mb-2">Connexion à SHADOW VPN:</h4>
                <input type="password" id="vpn-secret-code" placeholder="Mot de passe VPN..." required
                       class="w-full p-2 mb-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-1 focus:ring-green-400 text-sm">
                       
                <button type="submit" id="vpn-connect-button"
                        class="w-full py-2 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-500 transition duration-300 relative overflow-hidden">
                    <span id="vpn-button-text">Se Connecter</span>
                    
                    <!-- Loader de 6 secondes -->
                    <div id="vpn-loading-overlay" class="absolute inset-0 bg-green-700 flex items-center justify-center opacity-0 transition-opacity duration-300 pointer-events-none">
                        <svg class="button-spinner h-4 w-4 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 4.305c.291 1.255.438 2.544.438 3.824 0 4.418-3.582 8-8 8s-8-3.582-8-8c0-1.28.147-2.569.438-3.824m-4.882-1.571a.75.75 0 010-1.492.75.75 0 010 1.492zM20 12h2a10 10 0 00-20 0h2zm-8-8v2"></path>
                        </svg>
                        Vérification...
                    </div>
                </button>
                
                <p id="vpn-message-box" class="mt-2 text-xs text-center text-red-300 min-h-[1rem] opacity-0 transition-opacity duration-300"></p>
            </form>
            
        </div>
    </div>


    <script>
        // === Configuration et Variables Globales ===
        const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
        const SESSION_DURATION_MS = 10 * 60 * 1000; 
        const LOADING_DURATION_MS = 5000;
        const COOKIE_LOADING_DURATION_MS = 3000;
        const VPN_LOADING_MS = 6000; 
        
        const SECRET_CODES = ['95741', 'ERVIS', 'SHADOW1'];
        const VPN_SECRET_CODES = ['VPNSECURE', 'SECURESHADOW']; 
        
        const STORAGE_KEY = 'lastCookieCheck';
        const SESSION_EXPIRY_KEY = 'sessionExpiry'; 
        const VPN_STATUS_KEY = 'vpnStatus'; 
        const DOWNLOAD_URL = 'https://download1324.mediafire.com/elrhudzhi7egOf-ywAD086yPBeBHmLuhno6u_x0bxmZ93dRdnt_AdYoqPUL_wJd7nfN6y8XmwZ7UbdZuHbmWjFNTtRc2kOVJVy-p09tl_y77cyvkxe30ukub3r5EkILF_YMNRWeZ8J3-XyHgwWXonGnUOvp1_SU0BLZNRfZCpCQi/zmd22b97ksn9ibb/SHADOW+-+John+Wick+2014.mp4';
        
        // Constantes de Verrouillage
        const MAX_ATTEMPTS = 3;
        const LOCKOUT_DURATION_MS = 24 * 60 * 60 * 1000; 
        const WARNING_TIME_MS = 3 * 60 * 60 * 1000; 
        const ATTEMPTS_KEY = 'failedAttempts';
        const LOCKOUT_EXPIRY_KEY = 'lockoutExpiry';
        
        // === Références DOM ===
        const cookieModal = document.getElementById('cookie-modal');
        const accessGate = document.getElementById('access-gate');
        const loadingScreen = document.getElementById('loading-screen');
        const successContent = document.getElementById('success-content');
        const accessForm = document.getElementById('access-form');
        const secretCodeInput = document.getElementById('secret-code');
        const messageBox = document.getElementById('message-box');
        const loadingText = document.getElementById('loading-text');
        const loadingBar = document.getElementById('loading-bar');
        const downloadButton = document.getElementById('download-button');
        const lockoutStatusElement = document.getElementById('lockout-status');
        
        // DOM pour le VPN
        const vpnPanel = document.getElementById('vpn-panel');
        const vpnPasswordForm = document.getElementById('vpn-password-form');
        const vpnSecretCodeInput = document.getElementById('vpn-secret-code');
        const vpnMessageBox = document.getElementById('vpn-message-box');
        const vpnConnectButton = document.getElementById('vpn-connect-button');
        const vpnLoadingOverlay = document.getElementById('vpn-loading-overlay');
        const vpnButtonText = document.getElementById('vpn-button-text');
        const vpnDisconnectButton = document.getElementById('vpn-disconnect-button');
        
        // DOM pour les visuels
        const successHeader = document.getElementById('success-header');
        const successFooter = document.getElementById('success-footer');
        const downloadButtonVisual = document.querySelector('.download-button-visual');
        const downloadMessageBox = document.getElementById('download-message'); 
        const cookieButtonText = document.getElementById('cookie-button-text'); 
        const cookieLoader = document.getElementById('cookie-loader'); 


        let timerTimeoutId = null;

        // === Fonctions d'Utilité ===

        /** Affiche un message d'erreur ou de succès temporaire sur l'écran d'accès. */
        function displayMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('text-red-400', 'text-green-400');
            messageBox.classList.add(isError ? 'text-red-400' : 'text-green-400');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
            }, isError ? 4000 : 2000);
        }

        /** Met à jour le timer de verrouillage et réactive l'accès si le temps est écoulé. */
        function updateLockoutTimer() {
            const expiryTime = parseInt(localStorage.getItem(LOCKOUT_EXPIRY_KEY));
            const now = Date.now();
            
            if (expiryTime && expiryTime > now) {
                const remainingMs = expiryTime - now;
                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
                
                lockoutStatusElement.textContent = `VERROUILLÉ. Réinitialisation dans: ${hours}h ${minutes}m ${seconds}s`;
                lockoutStatusElement.classList.add('lockout-warning');

                timerTimeoutId = setTimeout(updateLockoutTimer, 1000); 
            } else {
                checkLockoutStatus(); 
            }
        }
        
        /** Affiche un message d'erreur ou de succès temporaire dans le panneau VPN. */
        function displayMessageVPN(text, isError = false) {
            vpnMessageBox.textContent = text;
            vpnMessageBox.classList.remove('text-red-300', 'text-green-300');
            vpnMessageBox.classList.add(isError ? 'text-red-300' : 'text-green-300');
            vpnMessageBox.classList.add('opacity-100');

            setTimeout(() => {
                vpnMessageBox.classList.remove('opacity-100');
            }, isError ? 3000 : 1500);
        }
        
        /** Affiche un message d'erreur ou de succès temporaire pour le téléchargement. */
        function displayDownloadMessage(text, isError = false) {
            downloadMessageBox.textContent = text;
            downloadMessageBox.classList.remove('text-red-400', 'text-green-400');
            downloadMessageBox.classList.add(isError ? 'text-red-400' : 'text-green-400');
            downloadMessageBox.classList.add('opacity-100');

            setTimeout(() => {
                downloadMessageBox.classList.remove('opacity-100');
            }, 3000);
        }


        // === Fonctions de Contrôle de l'Affichage et de la Sécurité ===

        /** Gère l'affichage initial du modal de cookies ou vérifie la session. */
        function checkCookieConsent() {
            const lastCheck = localStorage.getItem(STORAGE_KEY);
            const now = Date.now();

            if (!lastCheck || (now - parseInt(lastCheck) > ONE_WEEK_MS)) {
                showModal(cookieModal);
            } else if (checkSessionValidity()) { 
                showGate(true); 
            } else {
                showGate(false); 
            }
        }
        
        /** Vérifie la validité de la session de 10 minutes. */
        function checkSessionValidity() {
            const expiry = localStorage.getItem(SESSION_EXPIRY_KEY);
            if (!expiry || parseInt(expiry) < Date.now()) {
                localStorage.removeItem(SESSION_EXPIRY_KEY);
                return false;
            }
            return true;
        }

        /** Affiche un élément avec une animation fluide. */
        function showModal(element) {
            element.classList.remove('pointer-events-none', 'opacity-0');
            requestAnimationFrame(() => {
                element.classList.add('opacity-100');
                const modalContent = element.querySelector('div');
                if (modalContent && modalContent.classList.contains('scale-95')) modalContent.classList.remove('scale-95');
            });
        }

        /** Cache un élément avec une animation fluide. */
        function hideModal(element, callback) {
            const modalContent = element.querySelector('div');
            if (modalContent && modalContent.classList.contains('scale-95')) modalContent.classList.add('scale-95');

            element.classList.remove('opacity-100');
            element.classList.add('opacity-0');

            setTimeout(() => {
                element.classList.add('pointer-events-none');
                if (callback) callback();
            }, 700);
        }

        /** Gère l'accès à la page principale. */
        function showGate(isSuccess = false) {
            if (isSuccess) {
                hideModal(cookieModal);
                showSuccessPage();
            } else {
                hideModal(cookieModal);
                accessGate.classList.remove('opacity-0', 'pointer-events-none');
                accessGate.classList.add('opacity-100');
                checkLockoutStatus();
            }
        }

        /** Vérifie si l'utilisateur est verrouillé. */
        function checkLockoutStatus() {
            if (timerTimeoutId) clearTimeout(timerTimeoutId); 
            
            const expiryTime = localStorage.getItem(LOCKOUT_EXPIRY_KEY);
            const attempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || 0);
            const accessButton = accessForm.querySelector('button[type="submit"]');

            if (expiryTime && parseInt(expiryTime) > Date.now()) {
                secretCodeInput.disabled = true;
                accessButton.disabled = true;
                accessButton.textContent = "VERROUILLÉ";
                displayMessage("Le protocole de sécurité est activé. Tentative d'intrusion détectée.", true);
                updateLockoutTimer();
                return true;
            } else {
                localStorage.removeItem(LOCKOUT_EXPIRY_KEY);
                
                secretCodeInput.disabled = false;
                accessButton.disabled = false;
                accessButton.textContent = "ACTIVER LE PROTOCOLE";
                
                lockoutStatusElement.classList.remove('lockout-warning');

                if (attempts > 0) {
                    lockoutStatusElement.textContent = `Tentative d'accès: ${attempts}/${MAX_ATTEMPTS}`;
                } else {
                    lockoutStatusElement.textContent = '';
                }
                return false;
            }
        }
        
        /** Déclenche et gère l'écran de chargement de 5 secondes (initialisation). */
        function startLoading() {
            hideModal(accessGate);
            showModal(loadingScreen);

            let start = Date.now();
            let timer = 0;
            const interval = 50; 
            
            loadingText.textContent = `INITIATION DU PROTOCOLE (0%)...`;

            const loadingInterval = setInterval(() => {
                timer = Date.now() - start;
                let progress = Math.min(100, Math.floor((timer / LOADING_DURATION_MS) * 100));

                loadingBar.style.width = `${progress}%`;
                loadingText.textContent = `INITIATION DU PROTOCOLE (${progress}%)...`;

                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    // Définit l'expiration de session de 10 minutes
                    localStorage.setItem(SESSION_EXPIRY_KEY, Date.now() + SESSION_DURATION_MS);
                    showSuccessPage();
                }
            }, interval);
        }

        /** Affiche le contenu final (page de téléchargement) et initialise les couleurs. */
        function showSuccessPage() {
            hideModal(loadingScreen);
            showModal(successContent);
            if (downloadButton) downloadButton.disabled = false;
            
            // CORRECTION: Assure que le panneau VPN est initialement invisible et inactif sur la page de succès
            vpnPanel.classList.add('invisible', 'opacity-0', 'translate-y-full', 'pointer-events-none'); 

            // Initialise les visuels selon le statut VPN
            const isVpnConnected = localStorage.getItem(VPN_STATUS_KEY) === 'true';
            updateSecurityVisuals(isVpnConnected);
        }
        
        /** Bascule les visuels de sécurité (ROUGE <-> VERT). */
        function updateSecurityVisuals(isConnected) {
            const colorClass = isConnected ? 'green' : 'red';
            const oppositeColorClass = isConnected ? 'red' : 'green';
            const colorCode = isConnected ? '400' : '500';

            // 1. Header et Footer
            successHeader.classList.remove(`bg-${oppositeColorClass}-900/40`, `border-${oppositeColorClass}-700`);
            successHeader.classList.add(`bg-${colorClass}-900/40`, `border-${colorClass}-700`);
            successFooter.classList.remove(`bg-${oppositeColorClass}-900/40`, `border-${oppositeColorClass}-700`, `text-${oppositeColorClass}-${colorCode}`);
            successFooter.classList.add(`bg-${colorClass}-900/40`, `border-${colorClass}-700`, `text-${colorClass}-${colorCode}`);
            
            // 2. Texte de l'en-tête et du titre de téléchargement
            document.getElementById('header-text').classList.replace(`text-${oppositeColorClass}-400`, `text-${colorClass}-400`);
            document.getElementById('download-title').classList.replace(`text-${oppositeColorClass}-400`, `text-${colorClass}-400`);
            
            // 3. Bouton de téléchargement (Couleur et Ombre)
            downloadButtonVisual.classList.replace(`bg-${oppositeColorClass}-700`, `bg-${colorClass}-700`);
            downloadButtonVisual.classList.replace(`shadow-${oppositeColorClass}-900/80`, `shadow-${colorClass}-900/80`);
            
            // 4. VPN Disconnect Button
            if (isConnected) {
                vpnDisconnectButton.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-600');
                vpnDisconnectButton.classList.add('opacity-100', 'bg-green-600');
            } else {
                vpnDisconnectButton.classList.add('opacity-0', 'pointer-events-none');
                vpnDisconnectButton.classList.remove('opacity-100', 'bg-green-600');
            }
        }
        
        /** Gère l'acceptation ou le refus des cookies. */
        window.handleCookieAcceptance = function(accepted) {
            if (accepted) {
                // Afficher l'animation de chargement du bouton
                cookieButtonText.style.opacity = 0;
                cookieLoader.classList.remove('opacity-0', 'pointer-events-none');
                cookieLoader.classList.add('opacity-100');

                // Simuler le temps d'analyse
                setTimeout(() => {
                    localStorage.setItem(STORAGE_KEY, Date.now());
                    hideModal(cookieModal, () => {
                        showGate(false); // Passe à la porte d'accès
                    });
                }, COOKIE_LOADING_DURATION_MS);

            } else {
                // Refus (Simule une "fermeture" en cachant le modal et en le réaffichant au besoin)
                hideModal(cookieModal, () => {
                    // Si l'utilisateur refuse, on affiche l'écran de login, mais il peut revenir.
                    showGate(false); 
                    displayMessage("Protocole requis non accepté. Accès possible mais non recommandé.", true);
                    
                    // Réinitialiser le statut du bouton de cookie pour permettre une nouvelle tentative
                    cookieButtonText.style.opacity = 1;
                    cookieLoader.classList.add('opacity-0', 'pointer-events-none');
                });
            }
        }

        /** Déclenche le téléchargement du fichier. */
        window.startDownloadLoading = function() {
            downloadButton.disabled = true;
            displayDownloadMessage("Téléchargement initié... Redirection vers le fichier sécurisé.", false);
            
            setTimeout(() => {
                // Ceci simule le téléchargement. 
                displayDownloadMessage("Téléchargement simulé réussi. Fichier prêt.", false);
                downloadButton.disabled = false; 
            }, 2000); 
        }

        /** Affiche/Cache le panneau VPN (avec animation de glissement) */
        window.toggleVPNPanel = function() {
            if (vpnPanel.classList.contains('translate-y-full')) {
                // Ouvrir (Retire invisible/opacity-0, puis décale)
                vpnPanel.classList.remove('invisible', 'opacity-0', 'pointer-events-none');
                // Donne 50ms pour que les classes d'opacité/visibilité soient appliquées avant la transition de glissement
                setTimeout(() => {
                    vpnPanel.classList.remove('translate-y-full');
                }, 50);

            } else {
                // Fermer (Décale, puis ajoute invisible/opacity-0)
                vpnPanel.classList.add('translate-y-full');
                vpnPanel.classList.add('pointer-events-none');
                
                setTimeout(() => {
                    vpnPanel.classList.add('invisible', 'opacity-0');
                }, 500); // Temps après la fin de la transition (duration-500)
            }
        }
        
        /** Affiche le formulaire de mot de passe du VPN. */
        window.showVPNPasswordForm = function() {
            vpnPasswordForm.classList.remove('hidden');
        }
        
        /** Déconnecte manuellement du VPN. */
        window.disconnectVPN = function() {
            localStorage.setItem(VPN_STATUS_KEY, 'false');
            updateSecurityVisuals(false); // Rebascule en ROUGE
            displayMessageVPN("Déconnecté du VPN. Connexion non sécurisée.", true);
            vpnPasswordForm.classList.add('hidden'); // Cache le formulaire
            vpnSecretCodeInput.value = ''; // Efface le mot de passe
            toggleVPNPanel(); // Cache le panneau
        }

        // === Écouteurs d'événements ===
        
        // Formulaire principal
        accessForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (checkLockoutStatus()) {
                return; 
            }
            
            const inputCode = secretCodeInput.value.trim().toUpperCase();

            if (SECRET_CODES.includes(inputCode)) {
                // --- SUCCÈS ---
                localStorage.removeItem(ATTEMPTS_KEY);
                localStorage.removeItem(LOCKOUT_EXPIRY_KEY);
                lockoutStatusElement.textContent = '';
                
                displayMessage("ACCÈS AUTORISÉ. Préparation...", false);
                startLoading();
            } else {
                // --- ÉCHEC ---
                let attempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || 0) + 1;
                localStorage.setItem(ATTEMPTS_KEY, attempts);

                secretCodeInput.value = '';

                if (attempts >= MAX_ATTEMPTS) {
                    const expiryTime = Date.now() + LOCKOUT_DURATION_MS;
                    localStorage.setItem(LOCKOUT_EXPIRY_KEY, expiryTime);

                    displayMessage("CLÉ INVALIDE. ACCÈS TEMPORAIREMENT BLOQUÉ (24h).", true);
                    checkLockoutStatus();
                } else {
                    displayMessage("CLÉ D'ACCÈS INVALIDE. Tentative enregistrée.", true);
                    lockoutStatusElement.textContent = `Tentative d'accès: ${attempts}/${MAX_ATTEMPTS}`;
                }
            }
        });
        
        // Formulaire de connexion VPN
        vpnPasswordForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const vpnInputCode = vpnSecretCodeInput.value.trim().toUpperCase();
            
            // Désactiver le bouton et afficher le loader
            vpnConnectButton.disabled = true;
            vpnButtonText.style.visibility = 'hidden';
            vpnLoadingOverlay.classList.remove('pointer-events-none', 'opacity-0');
            vpnLoadingOverlay.classList.add('opacity-100');

            setTimeout(() => {
                // Rétablir l'état du bouton
                vpnConnectButton.disabled = false;
                vpnButtonText.style.visibility = 'visible';
                vpnLoadingOverlay.classList.add('opacity-0', 'pointer-events-none');

                if (VPN_SECRET_CODES.includes(vpnInputCode)) {
                    // --- SUCCÈS VPN ---
                    localStorage.setItem(VPN_STATUS_KEY, 'true');
                    updateSecurityVisuals(true); // Bascule en VERT
                    displayMessageVPN("Connecté au SHADOW VPN. Connexion Sécurisée.", false);
                    vpnPasswordForm.classList.add('hidden'); // Cache le formulaire après succès
                    vpnSecretCodeInput.value = '';
                    setTimeout(toggleVPNPanel, 1000); // Ferme le panneau après 1s
                } else {
                    // --- ÉCHEC VPN ---
                    localStorage.setItem(VPN_STATUS_KEY, 'false');
                    updateSecurityVisuals(false); // Reste en ROUGE
                    displayMessageVPN("Mot de passe VPN invalide.", true);
                    vpnSecretCodeInput.value = '';
                }
            }, VPN_LOADING_MS); // 6 secondes de chargement
        });


        // === Démarrage de l'Application ===
        window.onload = checkCookieConsent;

    </script>
</body>
</html>
